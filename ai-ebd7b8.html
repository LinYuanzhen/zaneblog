<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;👑&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>个人AI绘画小程序开发历程回顾（超详细）&nbsp;|&nbsp;ZaneBlog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="个人AI绘画小程序开发历程回顾（超详细）">
  
    <meta name="description" content="第一次尝试做一个完全自主设计的产品">
    <meta property="og:description" content="第一次尝试做一个完全自主设计的产品">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;👑&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">个人AI绘画小程序开发历程回顾（超详细）</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Oct 21, 2023</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/AI绘画.html">AI绘画</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/微信小程序.html">微信小程序</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/ebd7b894ffdb40f399972728edd656b9" class="PageRoot"><h1 id="https://www.notion.so/b00d4c40c49344a2b998027facc3254c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/b00d4c40c49344a2b998027facc3254c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">一、背景</span></span></h1><div id="https://www.notion.so/53ab3f2404304fae80b72cdec4b576f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2022年10月，一股AI绘画浪潮由太平洋的另一边汹涌而来，经领国的Noval AI而盛，再由B站、抖音席卷中国互联网。</span></span></p></div><div id="https://www.notion.so/c73a9a7f03624f049a0c3c77d54ba267" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/995383523b69468a8c413362d440fc9c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于从小就梦想绘画能够所思即所得的人来说，这种技术无异于魔法。当时刚刚冒出了独立开发一个产品的想法但苦于没有方向，这阵东风让我毫不犹豫地决定：开发一款AI绘画应用。</span></span></p></div><h1 id="https://www.notion.so/094a7a7b26f340d586cce53a09c6000b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/094a7a7b26f340d586cce53a09c6000b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">二、前期调研</span></span></h1><h2 id="https://www.notion.so/6af8f1a424934567bad4c69efe258e8a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6af8f1a424934567bad4c69efe258e8a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2.1 信息获取</span></span></h2><div id="https://www.notion.so/5b6f296027e54febad80f974be90b45f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那时AI绘画发展方兴未艾，各大搜索引擎上相关内容还很有限，前沿信息主要来源于B站和QQ群，传播模式主要为大佬摸索→发布教程→众人CV。</span></span></p></div><div id="https://www.notion.so/91211d22ff1d4e2d9b3f36b551e533ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那段时间，B站铺天盖地都是AI绘画（当然和大数据推荐也有关系），各种部署、模型、调参、操作教程直接把B站整成一个AI绘画学习APP，把人直接看到AI绘画 PTSD。当时也潜入了各大QQ群中，从中“窃取”了不少优秀的模型和prompt文档。</span></span></p></div><h2 id="https://www.notion.so/23099483b81649feab539003ce64dad0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/23099483b81649feab539003ce64dad0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2.2 市场分析</span></span></h2><div id="https://www.notion.so/ba3e44e5dcd9433db04cf48885c32a48" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那时候有一个头部应用在一个月内实现了用户破百万，我至今依然记得加入他们的一个新建AI绘画群时看到的疯狂景象。几千人的群，每个人都在分享自己生成的AI图片，聊天记录像滚动的日志一样令人眼花缭乱。我从中看到了这片新兴市场的火爆——即便是个人，也大有可为。</span></span></p></div><div id="https://www.notion.so/86572865e69844b9b3b76a69a9e43e07" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那时AI绘画的网页和APP已有不少，但小程序只有10+个，我几乎挨个都看了一遍。使用过程中发现这些应用界面大多比较混乱，信息繁杂，一大堆的模型让刚进去的用户不知从何下手，更别提还有满屏幕的弹窗和贴片广告，以及强制登录，还有高到吓人的会员费。</span></span></p></div><div id="https://www.notion.so/502a4228c1c24ec389f810d39c19435c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在产出图形式上，他们主要集中于风景和真人，还有真人照片转二次元。风景的成图乏善可陈，真人大多都是恐怖片，最受欢迎的是照片转二次元（后来抖音也做了这块功能），但出图效果和我在QQ群里看到的还是有差距。我认为真实图片的AI绘画还有一段路要走，而二次元对各种瑕疵和缺陷的包容度是最高的，有时候三条腿多手指两个头反而会让人觉得很好笑。</span></span></p></div><h2 id="https://www.notion.so/fe86f41328e14cfc988ed2ceae469bd8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/fe86f41328e14cfc988ed2ceae469bd8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2.3 产品定位</span></span></h2><div id="https://www.notion.so/0deb7bed23d046488591df0216fdd7da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我当即决定主打二次元绘画方向，面向十几二十岁的年轻人，他们是对AI绘画这类新事物接受度最高的人群。考虑到这是一片小蓝海，大家都在抢跑，而我是独立开发，前期功能要尽量精简，优先追求完成而不是完美。AI绘画对于大多数人来说还很新，界面操作一定要尽量傻瓜，前期为吸引用户，保持免费无广告。至于应用的前端形式，APP成本太高，网页流量太少，小程序是支持以个人为主体的，上手难度也不高，目前竞争也不激烈，我很自然地就选择了小程序。</span></span></p></div><h2 id="https://www.notion.so/f6a0d68e1b1049928eda61da2eb986b2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f6a0d68e1b1049928eda61da2eb986b2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2.4 技术选型</span></span></h2><div id="https://www.notion.so/31e58569171f4b08bc146ab4cdc1b3b8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">还有一个最关键的模块——后端系统。当时主要有Novel AI和stable diffusion两大后端系统，前面说到这股AI绘画风潮就是自NovelAi而起。很多开发者很自然地选了这个系统来部署，优点是操作简单，无需调参就能得到质量很高的成图，但它是一个商业系统，并不开源，操作简单也意味着它的自定义程度很低。而stable diffusion是一个正在被持续维护的开源系统，每天都有好多人提issue，也有源源不断的pr和fix。Novel AI本身也是基于stable diffusion进行二次开发的，这也意味着Novel AI的模型可以直接拿来给stable diffusion用，只需调整stable diffusion的参数，就能得到近似甚至超越Novel AI的图片效果。我选择了stable diffusion。</span></span></p></div><h1 id="https://www.notion.so/e7c4677ffe034d0e8d79fa9665da6d25" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/e7c4677ffe034d0e8d79fa9665da6d25"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">三、产品功能</span></span></h1><div id="https://www.notion.so/8ee04a57125e445ca96409d43bee83fe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">目前这款AI绘画小程序的大部分预想功能都已经实现了，并且已经停止运营。下面我将她展开铺平，逐个介绍各个页面功能。</span></span></p></div><h2 id="https://www.notion.so/14d478e40b174f0a997d7582df2a0345" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/14d478e40b174f0a997d7582df2a0345"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3.1 首页</span></span></h2><div id="https://www.notion.so/3b04dec704ed44c788d6b56a120266ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首页是一个简单的瀑布流，用于展示一些比较优秀的作品，这些图片都被存放在对象存储服务器中。顶部是可以实时更新的公告，主要用于展示版本更新信息和一些临时通知事项。</span></span></p></div><div id="https://www.notion.so/13b99411dacf461db9933ed4f3003caa" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F31aa84e3-df7e-4681-9886-c92a62eb82ac%2F%25E9%25A6%2596%25E9%25A1%25B5-compress.jpg?width=288&amp;table=block&amp;id=13b99411-dacf-461d-b993-3ed4f3003caa"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F31aa84e3-df7e-4681-9886-c92a62eb82ac%2F%25E9%25A6%2596%25E9%25A1%25B5-compress.jpg?width=288&amp;table=block&amp;id=13b99411-dacf-461d-b993-3ed4f3003caa" style="width:288px"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">3-1 首页</span></span></figcaption></figure></div><h2 id="https://www.notion.so/cc97907935a1474a8fea83052b639c74" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cc97907935a1474a8fea83052b639c74"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3.2 功能页-功能面板</span></span></h2><div id="https://www.notion.so/e63996c168fb451bb8aef3ce724e5603" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">“召唤”页的只有文生图和图生图两大功能，用户进入界面后，直接点击“开始召唤”即可生成图片，或者也可以从上到下依次自定义：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/978b96938c3447bbb9a88c87bf3a90f0" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">提示词 —— 决定生成什么样的图片</span></span></li><li id="https://www.notion.so/d8f7a56982914d97bcfc4f20b04806e9" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">图片尺寸 —— 这里只给了比例而不给实际尺寸，也是出于简化的目的</span></span></li><li id="https://www.notion.so/db1c760b27a74b2da6e987eff5b16190" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">单次生成图片数量 —— 为减轻服务器压力，最多支持5张</span></span></li><li id="https://www.notion.so/81f92bf42b954d65a4753a327c88c2ad" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">基础大模型 —— 决定图片风格的关键选项</span></span></li><li id="https://www.notion.so/d2a2fe9f60204550b0e4f409a3092642" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString">lora —— 微调模型，最多支持叠加3个，可以依次选择不同百分比</span></span></li><li id="https://www.notion.so/c7adbfd06ae5495da438850e1ae2d22a" class="NumberedList" value="6"><span class="SemanticStringArray"><span class="SemanticString">上传图片 —— 如果想要图生图，就需要在此上传图片</span></span></li></ol><div id="https://www.notion.so/4bd1cb6beea34a1893033cbef6933c29" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/a6f16bdaced84208998b01104ad8a065" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">点击商店图标可以购买用于批量生成图片的积分（单图免费），也可以查看自己的历史订单。历史订单中会标注每一个订单的状态，包含</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">未激活</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">已关闭</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">未使用</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">使用中</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">已用完</code></span><span class="SemanticString">五个状态，扣除积分时，会按照 蓝药水→旧订单中的红药水→新订单中的红药水 这样的先后顺序，目的是保障付费用户权益——如果新订单中的红药水尚未使用，则支持全额退款。</span></span></p></div><div id="https://www.notion.so/548ba7f1b8594a288fa7ee83abd4378a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/df450704d7ad43cb9da2f12a6fd3c123" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">商店图标下方是一个广告链接，点击后会触发微信小程序的激励广告，看完后可奖励积分，每日有观看次数上限。</span></span></p></div><div id="https://www.notion.so/f8557e26d63846fa9e3b19568dd677d0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/a82fb3307adf4e558ce97f11f21b3d48" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">最底部的高级设置用于满足高阶用户需求，为他们提供更多维度的自定义玩法。</span></span></p></div><div id="https://www.notion.so/9dff2e36461c4fbf865bd9f809a07ae5" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F21472d24-86f0-40a0-b410-745e906a107a%2F%25E5%258A%259F%25E8%2583%25BD%25E9%25A1%25B5%25E9%259D%25A2%25E6%259D%25BF.jpg?width=5069&amp;table=block&amp;id=9dff2e36-461c-4fbf-865b-d9f809a07ae5"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F21472d24-86f0-40a0-b410-745e906a107a%2F%25E5%258A%259F%25E8%2583%25BD%25E9%25A1%25B5%25E9%259D%25A2%25E6%259D%25BF.jpg?width=5069&amp;table=block&amp;id=9dff2e36-461c-4fbf-865b-d9f809a07ae5" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">3-2 核心功能页，由于主打二次元，所以仿的B站色系</span></span></figcaption></figure></div><div id="https://www.notion.so/6b6c8406b309401b839907609aace20e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/f94c03c0758443c5a8d9d7223ec45cd7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f94c03c0758443c5a8d9d7223ec45cd7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3.3 功能页-图片生成流程</span></span></h2><div id="https://www.notion.so/157a18b000194beda62b5b03354d6177" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">受限于现有的AI技术和硬件水平，AI绘画应用与普通应用最大的不同在于，它的核心功能请求是无法得到即时反馈的，或者说，它是长阻塞的。用户从点按“开始召唤”按钮，到得到最终图片，其间往往需要等待几十秒甚至几分钟的时间（有些资源富足的小程序只需要几秒），中间还需要经历词和图的两道审核，所以把每个阶段的结果及时响应给用户就变得非常关键。</span></span></p></div><div id="https://www.notion.so/e7dbbf9c95ed417187cd340e30c810c9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">考虑到单图和多图展示空间的差异性，会区分两种场景展示不同尺寸的图片。</span></span></p></div><div id="https://www.notion.so/e905ff040d9249cc9b63aaa125a69b5b" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F120d6296-f646-491b-934f-ead0f4932e42%2F%25E5%259B%25BE%25E7%2589%2587%25E7%2594%259F%25E6%2588%2590%25E6%25B5%2581%25E7%25A8%258B.jpg?width=6152&amp;table=block&amp;id=e905ff04-0d92-49cc-9b63-aaa125a69b5b"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F120d6296-f646-491b-934f-ead0f4932e42%2F%25E5%259B%25BE%25E7%2589%2587%25E7%2594%259F%25E6%2588%2590%25E6%25B5%2581%25E7%25A8%258B.jpg?width=6152&amp;table=block&amp;id=e905ff04-0d92-49cc-9b63-aaa125a69b5b" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">3-3 图片生成流程图</span></span></figcaption></figure></div><h2 id="https://www.notion.so/480bfd93b55b42c39476c687b241c5f0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/480bfd93b55b42c39476c687b241c5f0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3.4 功能页-MidJourney</span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">[1]</mark></span></span></h2><div id="https://www.notion.so/6a1bb155016c48c08c0c181e6d20055e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">与“召唤”页面相比，“MJ”页面的交互体验会更好，进入页面时，系统会自动拉取用户当前生图任务的进度，例如排队进度（无上限）、图片生成进度（百分比）等，还会默认展示最近生成的一张图片。用户即便点击重新进入小程序，或者从移动端小程序切换到PC端，也能同步看到任务进度。MJ原生支持的命令参数和图生图模式，本小程序也都完整支持。</span></span></p></div><div id="https://www.notion.so/1e9cc8eae40e4418a7914fa3a20ddf56" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fd7defd3a-78eb-4b48-ab84-a50ae19c2c44%2Fmj%25E6%2596%2587%25E8%25BA%25AB%25E5%259B%25BE-compress.jpg?width=288&amp;table=block&amp;id=1e9cc8ea-e40e-4418-a791-4fa3a20ddf56"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fd7defd3a-78eb-4b48-ab84-a50ae19c2c44%2Fmj%25E6%2596%2587%25E8%25BA%25AB%25E5%259B%25BE-compress.jpg?width=288&amp;table=block&amp;id=1e9cc8ea-e40e-4418-a791-4fa3a20ddf56" style="width:288px"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">3-4 展示排队进度，支持MJ原生命令参数</span></span></figcaption></figure></div><div id="https://www.notion.so/9b52f73153cc4d28bc48ddd1723033f9" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fa034ab50-bdb8-424f-aead-3c34a67df219%2Fmj%25E7%2594%259F%25E5%259B%25BE%25E8%25BF%259B%25E5%25BA%25A6.jpg?width=288&amp;table=block&amp;id=9b52f731-53cc-4d28-bc48-ddd1723033f9"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fa034ab50-bdb8-424f-aead-3c34a67df219%2Fmj%25E7%2594%259F%25E5%259B%25BE%25E8%25BF%259B%25E5%25BA%25A6.jpg?width=288&amp;table=block&amp;id=9b52f731-53cc-4d28-bc48-ddd1723033f9" style="width:288px"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">3-5 排队结束，展示图片生成进度</span></span></figcaption></figure></div><h2 id="https://www.notion.so/f7ee619595f847f19b1a7e879f78a89d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f7ee619595f847f19b1a7e879f78a89d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3.5 功能页-高清放大</span></span></h2><div id="https://www.notion.so/6cc2851accc84124a207a4ae0e1d7ba9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">“进化”页的功能比较简单，就是将图片进行原地高清放大，产出图相较原图会变高清，同时尺寸也会变大。不过为了防止GPU和带宽资源过载，限制了图片的最大尺寸和大小，同时会在小程序侧对上传图片进行预压缩，在服务端也会对产出图进行一定程度的压缩。</span></span></p></div><div id="https://www.notion.so/c4d00f8bc09a41c8a9361a32efe80552" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Feeac8b27-1457-4784-8c3c-ca77470ad41a%2F5221697949948_.pic.jpg?width=336&amp;table=block&amp;id=c4d00f8b-c09a-41c8-a936-1a32efe80552"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Feeac8b27-1457-4784-8c3c-ca77470ad41a%2F5221697949948_.pic.jpg?width=336&amp;table=block&amp;id=c4d00f8b-c09a-41c8-a936-1a32efe80552" style="width:336px"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">3-6 高清放大</span></span></figcaption></figure></div><div id="https://www.notion.so/5d4ea0e2970e42ee81c154dfb3fb7ae5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9969fcbc0f5f4d78a4908cc4014c6768" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/01045e59ea0e4d7ea664c8b2b44d968c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/01045e59ea0e4d7ea664c8b2b44d968c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3.6 我的</span></span></h2><div id="https://www.notion.so/d80d40961ffa4805bf097dafbe07b157" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">“我的”页面主要用于为用户提供一个反馈入口，提供加客服企微和直接唤起小程序原生客服对话框两种方式。充电页面用于提供支付赞助功能。</span></span></p></div><div id="https://www.notion.so/f4f4d0bb49d84e1abf6235c861546a26" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fbbd1ade3-9e96-4662-af23-c5a68c69a5a3%2F%25E6%2588%2591%25E7%259A%2584-%25E9%259D%25A2%25E6%259D%25BF.jpg?width=2911&amp;table=block&amp;id=f4f4d0bb-49d8-4e1a-bf62-35c861546a26"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fbbd1ade3-9e96-4662-af23-c5a68c69a5a3%2F%25E6%2588%2591%25E7%259A%2584-%25E9%259D%25A2%25E6%259D%25BF.jpg?width=2911&amp;table=block&amp;id=f4f4d0bb-49d8-4e1a-bf62-35c861546a26" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">3-7 我的页面概览</span></span></figcaption></figure></div><h1 id="https://www.notion.so/ccf39c37307849828ac0471a27563318" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/ccf39c37307849828ac0471a27563318"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">四、系统架构</span></span></h1><h2 id="https://www.notion.so/d17ad46f051f432bb317076fac611811" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d17ad46f051f432bb317076fac611811"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.1 服务分布</span></span></h2><div id="https://www.notion.so/27c6165771d44aa0b86cd30ac093a96b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">图4-1 以三个不同文生图请求的路径为例，展示了本小程序后端服务的部署和交互方式。</span></span></p></div><div id="https://www.notion.so/4186d814c9bc42ee82cebe1858c4e64e" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F5da902a7-42b0-4b9b-a1ad-5970e41ca851%2FUntitled.jpeg?width=2335&amp;table=block&amp;id=4186d814-c9bc-42ee-82ce-be1858c4e64e"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F5da902a7-42b0-4b9b-a1ad-5970e41ca851%2FUntitled.jpeg?width=2335&amp;table=block&amp;id=4186d814-c9bc-42ee-82ce-be1858c4e64e" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">4-1 各服务部署分布图</span></span></figcaption></figure></div><div id="https://www.notion.so/6ddbe44d3f384d0aacf8dc5cc0418086" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f05948626e1d426fb2774dcb472f5d30" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我最终选择部署的后端系统是</span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Unknown">‣</span></span><span class="SemanticString">（以下简称SD），它其实具备了完整的WebUI，直觉上看拿来就能用，无需另外的架构设计。但我的需求是做一个完整的AI绘画小程序，涉及到翻译、鉴权、审核、支付等业务功能，而SD能提供的就只有生图api，这样其余功能都需要通过另外一个系统实现。当然也可以选择对SD进行二开，但首先二开工作量不一定比新写一个系统小，另外最重要的是，我是一个Python生手 😅</span></span></p></div><div id="https://www.notion.so/21e15f4ec82d4fe6936403bf13e46297" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ea067470a4c24f4e86d2170d13307f96" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">所以我最终的设计是，让每个SD服务都配合一个SpringBoot服务来使用，前者只负责跑图，业务功能由后者实现。但这种分工对前端是透明的，从业务层面看，它们是一个整体，实际它们也是被部署在同一台机器上的。从可用性角度来说，不同服务应当部署在不同机器上，但由于GPU服务器耗能巨大，一般云厂商都会为这类服务器分配较高的CPU和内存资源，而SD本身主要消耗的是显存，剩余的资源刚好留给SpringBoot服务，这样就免去了另外租用应用云服务器的成本。至于为什么一台服务器中会同时存在多个版本的SpringBoot服务，可见下文</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">版本发布。</strong></span></span></p></div><div id="https://www.notion.so/df685e87b0cb422dbcaae27fa8df50f9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3f1b8fda02394d3f8ce7119472133344" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SD服务本身又该如何部署呢？用户想要尽可能多的大模型，但一个SD服务同一时刻只允许加载一个大模型，且不支持毫秒级切换模型的操作</span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">[2]</mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">。</mark></span><span class="SemanticString">这意味着每个SD服务只能绑定一个大模型，用到几个大模型，就需要部署几个SD服务。</span></span></p></div><div id="https://www.notion.so/65f1afebb4dd45ac913da24b6e6986f9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/fb59708e9e874a8ab4afb9a167f1015a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本小程序最高峰时一共用到了6个大模型，那就需要部署6个SD服务。这需要几台GPU服务器，每台部署几个服务呢？如果一台一个的话，图片的生成速度自然是最快的，但是由于SD本身自带了一个串行锁，同一时间只允许执行一个请求，所以这么做服务器的资源是无法得到充分利用的，在请求量较高时，反而可能造成串行阻塞。同时这么做也意味着，用到多少个模型就需要几台GPU服务器，这高昂的成本也不是多少开发者能够承受的。但如果单台服务器部署过多服务的话，请求数增多时，又容易造成显存溢出。</span></span></p></div><div id="https://www.notion.so/0004a4c16f9d4ac9b20e86b30067131b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/e3d2960a1e914f1fa6c0fac47b0b0bfa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从请求量、生图速度、GPU服务器成本、大模型需求数量等因素综合考虑，我最终决定租用两台GPU服务器，每台部署三个模型（SD服务），同时将使用频次较高的热点模型均匀分配到两台机器上以均衡负载。两台服务器在一定程度上也能起到提高可用性的目的，结合预期收入来看，成本风险也在个人的承受范围内。</span></span></p></div><div id="https://www.notion.so/188672a6ce974962baed48e40196d1f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8a075e81e48441bb9815cd1aaf6680b4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">剩下的一些Nginx、frp、Redis、MySQL等中间件数据库服务都被部署在了同一台应用云服务器上（没错，原因同样是为了节约成本）。在这里Nginx的主要功能不在于负载均衡，而是将请求基于URL路径转发到对应版本的SpringBoot服务上，具体见下文</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">版本发布</strong></span><span class="SemanticString">；需要frp的原因是，GPU服务器是从AutoDL租赁的，他们对对外端口的限制较为严格，为了同时将多个服务暴露出去，只能借助内网穿透。</span></span></p></div><h2 id="https://www.notion.so/b5215b4fefb14278be9401914d6077ab" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b5215b4fefb14278be9401914d6077ab"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.2 SD生图请求流程详解</span></span></h2><div id="https://www.notion.so/558f7b30949e4f1ab8bc19c808c75d0f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下图展示了一个完整的图生图请求交互流程，包括其中涉及到的各个服务组件。</span></span></p></div><div id="https://www.notion.so/f321697891b94a749f5ea95773fe11af" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一个完整的流程包括以下几个关键步骤：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/8dc3c643a65448f2b46aac408099355e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">校验 —— 包括敏感词审核、请求频率校验、积分校验</span></span></li><li id="https://www.notion.so/ebaa799983f44555a9a2633944034d01" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">翻译</span></span></li><li id="https://www.notion.so/a38fdd567ad7438795c3855c24ca029c" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">获取入参图片</span></span></li><li id="https://www.notion.so/27ab6c7cddfa405d8e737d8cb7100300" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">调用SD生图API</span></span></li><li id="https://www.notion.so/e819b246864046dea49b28e1a5b2c967" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString">产出图审核</span></span></li></ol><div id="https://www.notion.so/8ff27865507a44518a828b836e7d6a8e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3c09aa3572cc48549d016448b91c7789" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">两个显得冗余的操作是翻译和获取入参图片。翻译需要请求Redis的原因是，各大厂商提供翻译API价格都是很昂贵的，而用户的操作习惯是，同样的词会连续跑几次甚至几十次，这对于API资源来说是巨大的浪费。一开始我还为翻译API付过费，接入缓存之后就再也没超出过免费额度。</span></span></p></div><div id="https://www.notion.so/b50731c82bc74abbaab31ff551f52311" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/06640f24132c4d919f35a34f7a4d76ab" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">而获取入参图片的操作就更显诡异，为什么不直接从对象存储服务器中获取呢？其实还是为了节约成本（没错，省钱这个理念是贯穿了整个开发周期的 🥲）。国内对象存储服务收费都很高，国外的服务在国内访问又有难以忍受的延迟，考虑到入参图片只需要临时存储，所以最终采用了将其直接存放在服务器本地硬盘上，再通过接口暴露出去的方案（当然做了一些访问路径的限制）。不同服务器可以通过接口相互访问，内网不消耗流量，且速度客观，实际实施起来是可行的。</span></span></p></div><div id="https://www.notion.so/272f745b5e7b4212a4fccabf94a6efec" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F00f2bf74-5bd2-4bd4-94a7-d4346317f5bd%2FSD%25E7%2594%259F%25E5%259B%25BE%25E8%25AF%25B7%25E6%25B1%2582%25E4%25BA%25A4%25E4%25BA%2592%25E5%2585%25A8%25E8%25B7%25AF%25E5%25BE%2584%25E8%25A7%25A3%25E6%259E%2590.jpg?width=2948&amp;table=block&amp;id=272f745b-5e7b-4212-a4fc-cabf94a6efec"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F00f2bf74-5bd2-4bd4-94a7-d4346317f5bd%2FSD%25E7%2594%259F%25E5%259B%25BE%25E8%25AF%25B7%25E6%25B1%2582%25E4%25BA%25A4%25E4%25BA%2592%25E5%2585%25A8%25E8%25B7%25AF%25E5%25BE%2584%25E8%25A7%25A3%25E6%259E%2590.jpg?width=2948&amp;table=block&amp;id=272f745b-5e7b-4212-a4fc-cabf94a6efec" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">4-2 SD生图请求交互路径图</span></span></figcaption></figure></div><div id="https://www.notion.so/2f25a9a0e2d04b54a6d946599837b5df" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/aa85ccd464784cdb9f11a69175b39433" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/aa85ccd464784cdb9f11a69175b39433"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.3 MidJourney生图流程详解</span></span></h2><div id="https://www.notion.so/270a6a53a77b43eda5534051ce3c64ba" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fce7f8d12-883a-49d2-80ed-466e3f4f38f3%2Fmidjourney%25E8%25AF%25B7%25E6%25B1%2582%25E8%25B7%25AF%25E5%25BE%2584.jpg?width=3634&amp;table=block&amp;id=270a6a53-a77b-43ed-a553-4051ce3c64ba"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fce7f8d12-883a-49d2-80ed-466e3f4f38f3%2Fmidjourney%25E8%25AF%25B7%25E6%25B1%2582%25E8%25B7%25AF%25E5%25BE%2584.jpg?width=3634&amp;table=block&amp;id=270a6a53-a77b-43ed-a553-4051ce3c64ba" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">4-3 MidJourney生图请求交互路径图</span></span></figcaption></figure></div><h3 id="https://www.notion.so/32f9e2845ca74141b88c09a100ec65ac" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/32f9e2845ca74141b88c09a100ec65ac"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.3.1 反向代理</span></span></h3><div id="https://www.notion.so/73aaa281c05b4380a4a4b05f453409d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">MJ是一个海外服务，只能通过discord访问。但既然discord能访问，我们自然也可以通过它暴露给discord的接口拿到鉴权信息，直接访问。这里我使用了国内的一个MJ代理开源项目</span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Unknown">‣</span></span><span class="SemanticString">，也就是图4-3中右下方的mj-proxy，它支持MJ原生的imagine和垫图等各种操作，还实现了排队进度和任务进度，为我们省去了大量与MJ官方接口交互的逻辑。由于国内无法直接访问MJ，MJ返回的图片URL也无法打开，因此需要将mj-proxy部署在一台国内能够访问、同时又能够访问MJ的VPS上，并在其上部署nginx，对最终成图的URL域名进行反向代理。</span></span></p></div><div id="https://www.notion.so/c23acc0130df44db8a194d3e927d85c2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/57515df038914613933bfc3cdc6c8319" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">部署完成后，剩下的工作似乎就只剩下通过后端服务直接调用mj-proxy提供的API了，但图4-3纷乱的箭头告诉我们事情并没有那么简单。</span></span></p></div><div id="https://www.notion.so/16b5b7d28e67437db571482ad810cdb7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/1f00810f10584865b2e0216f1122a2ba" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1f00810f10584865b2e0216f1122a2ba"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.3.2 排队</span></span></h3><div id="https://www.notion.so/1f3bc7ef760a4a2791b420f6a9d09002" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">核心问题在于排队进度。由于事先调研了其它小程序MJ的使用量，可以预料到这个功能上线后会有大量用户使用，当请求量较高导致阻塞时，一定要提供一个良好的进度反馈体验。</span></span></p></div><div id="https://www.notion.so/6bef59e66a104db4aa01da59c07f54b8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/80d828d8ca324e8a8223bfcc6c887f7e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在设计阶段，我对排队功能的需求是：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/6c85492d3735488e9af2dcc675b3cc68" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">实时展示某用户请求排队进度</span></span></li><li id="https://www.notion.so/72abed28308e4386b7124d5f02990c54" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">排队人数无上限</span></span></li><li id="https://www.notion.so/35f4dc1e90794da895286de3094fe1ee" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">已发起的请求不会丢失</span></span></li><li id="https://www.notion.so/72480eb3a27d4bbfb40580716748fc1a" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">失败请求会被添加到执行中队列的末尾，自动重试</span></span></li><li id="https://www.notion.so/78cd19b14100462e840ef7417cecf927" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString">删除指定无效对象</span></span></li></ol><div id="https://www.notion.so/bd78aeb192994dcfa8e717793a72dc80" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/fd055af5dea744c28d669f334c7f91ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">前面说mj-proxy已经提供了排队进度功能，为什么不能直接用？原因有三：</span></span></p></div><div id="https://www.notion.so/3170b5a81ce24b25b7a60403a5cad487" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">1、MJ原生排队机制问题</span></span></p></div><div id="https://www.notion.so/da3341f860b847b6bc28e7fb33146884" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">MJ原生也是有排队机制的，就标准账号而言，可以允许有三个并发任务，但队列中最多只允许存放10个任务，再多就直接丢弃了（具体可以参考它们的订阅计划</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.midjourney.com/docs/plans">Midjourney Subscription Plans</a></span><span class="SemanticString">）。在这一点上，mj-proxy并没有做任何改进（当时版本）。这就与需求2和3不匹配了。</span></span></p></div><div id="https://www.notion.so/c6378fa3c2874f9da5fe90685646ded9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2、失败重试问题</span></span></p></div><div id="https://www.notion.so/7e4b87c1746c42249a8a1d7693907974" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">mj-proxy并不提供失败重试功能接口</span></span></p></div><div id="https://www.notion.so/174928dc19784ebe8a6fc4894ad6df80" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">3、共享账号问题</span></span></p></div><div id="https://www.notion.so/fb63391d7d2449038a98538484c07c86" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">出于成本考虑，我使用的是淘宝上购买的MJ 6人共享账号，共享也就意味着，你并不知道某一时刻真正在MJ执行的请求有多少个，从MJ官方和mj-proxy中都没有找到此类查询接口。那就只能以服务本身发出的请求为度量，队列前3个请求的状态都认为是执行中，后面新增的请求都会进入排队状态。这种限制实际也是为了保障共享账号其它购买者的体验，我不能蛮不讲理地将队列一直占满，其它用户的手速一定是比不过程序的调用速度的。当然这也是为了规避被账号卖家拉黑的风险。</span></span></p></div><div id="https://www.notion.so/cb3d6546f9e74740af8ace180b01838d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">4、多账号问题</span></span></p></div><div id="https://www.notion.so/84e080f7b25445c3909b78cdfa16d079" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">由于SD生图的压力一直很大，MJ自然就承担起了为SD分流的角色。因此只有一个账号是不够的，预估的时候我认为至少需要两个。当时mj-proxy的账号池功能还在TODO List里面，这样要实现多账号，就需要部署两个mj-proxy服务，每个服务都对应一个账号。这时候直接使用mj-proxy的排队功能的话，就会出现排队进度“跳变”的情况。因为两个mj-proxy是作为一个分布式集群被均衡访问的，用户可能首先访问的是其中一个服务，刷新过后又访问到了另外一个服务，而两个服务的排队进度并不相同。或者还可能会出现用户A先访问了服务A，用户B访问了服务B，但用户B的排队进度反而在用户A之前的情况。</span></span></p></div><div id="https://www.notion.so/517beb79829e4317849909453104bf9a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9acde278433d480ebcd4706d348f1dc9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">基于上述问题，排队功能不能倚靠第三方，需要自行实现。</span></span></p></div><div id="https://www.notion.so/c640ee0f2e6f4beda14433295c84ab4f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/83d400904e7c41c3af5e7d23e1319a5e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首先对队列进行选型，将需求转换为对队列的要求：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/03675481dbb2440fa4dc9cb1e90bf03f" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">根据需求一，需要通过对象获取位置</span></span></li><li id="https://www.notion.so/fa60fae92cab4fc09bbc39243c240ded" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">根据需求一，需要翻转队列中指定位置请求的状态</span></span></li><li id="https://www.notion.so/030b315baddf4cb09af11e05fa43caba" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">根据需求四，需要添加请求到指定位置</span></span></li><li id="https://www.notion.so/d04e6beb0b08431b80884a5c54f1f178" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">根据需求五，需要删除指定对象</span></span></li></ol><div id="https://www.notion.so/e37d4401cd5c4c3386e0ee72c857065e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/60f873dc2bc441138165b2247f4ec762" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上述要求相对简单，都无需引入MQ，用Redis提供的大部分队列都能够实现，但考虑到对位置的操作要求，只有list能够非常灵活高效地满足，最终选择了RList来作为队列类型。</span></span></p></div><div id="https://www.notion.so/466e15a1b1e54e9ca1bd180844eca339" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/677994153e254298989e7acae20bb7e2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/677994153e254298989e7acae20bb7e2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.3.3 任务定时健康检查</span></span></h3><div id="https://www.notion.so/fdcbe45a9d2a4971b9d10b3a5d783027" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">考虑到SpringBoot服务和mj-proxy服务异常重启、网络异常、程序bug可能导致的任务状态切换异常，设置了一个单点定时线程来对队列中的任务进行定期检查，纠正任务的异常状态，以及及时唤醒假死任务、删除死亡任务，保证整个队列健康运转。要知道一个账号就只有3个并发，一个假死任务可能会很长时间就占去一个并发名额，所以定时的健康检查是至关重要的。</span></span></p></div><div id="https://www.notion.so/4740516bb43c48bd92309ca267503c8a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/dbc01080a41f4a6786ab72bccb45e1f0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/dbc01080a41f4a6786ab72bccb45e1f0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.3.3 连接方式</span></span></h3><div id="https://www.notion.so/9876324f0edf4838a14e2a734014e13e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为了实时查看排队和生图进度，前端需要和后端保持频繁的请求交互。实现这种需求的常见方式有三种：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/f0209e3c4bea40f3a1da16f8fa3e181e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">长连接</span></span></li><li id="https://www.notion.so/0b48a1079b614c258ddeb4a9ed57ddc1" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">轮询</span></span></li><li id="https://www.notion.so/93f88063882745158139209b3a4d5785" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">WebSocket</span></span></li></ol><div id="https://www.notion.so/4ffd9c95fdc1400b96994f14307c18fe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/7b1621cd391a47f4acd860bb807b06ea" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">微信小程序有它的特殊性，在切至后台后，所有HTTP请求都会被强制中断，所以长连接在小程序是无法使用的。轮询是一个可行的操作，本小程序的SD生图页面采用的就是这种方式，缺点是比较耗性能。WebSocket相对而言是最优解，所以在开发MJ模块的时候，就采用了这种方式。WebSocket不仅允许客户端向服务端发送请求，还能让服务端主动将请求推送到客户端，而且过程中都是复用一个连接，大大降低了性能损耗，非常适合MJ绘图这类需要频繁推送进度信息的业务场景。</span></span></p></div><div id="https://www.notion.so/96d3f18a425f40f7bdd54f349634ab4b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/04ddde85ee524203af52ca88999e831a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/04ddde85ee524203af52ca88999e831a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.3.4 分布式场景下的多端进度同步</span></span></h3><div id="https://www.notion.so/9ef72a9ce88447b1b1f61c0351c14d27" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">众所周知，小程序是既有移动端又有PC端的，如何保证在用户同时操作多端时，保持多端之间的进度同步呢？</span></span></p></div><div id="https://www.notion.so/ccdfb28336e94b6981b5819027f93b4f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们首先想到分布式session，但WebSocket的设计理念就是点对点，WebSocketSession是无法序列化的，不能存入Redis，只能放在本机内存中。</span></span></p></div><div id="https://www.notion.so/f5c6c75d385e43698a812bf57ef2c609" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">用户每发起一次WebSocket连接，都会在内存中创建一个新的WebSocketSession，当同时访问多端时，他的session就可能会散落在不同机器上。而mj-proxy发起回调时，只会命中其中一台机器，无法实现全局session同步推送。</span></span></p></div><div id="https://www.notion.so/19d0ee12500b4faa8ba2fa59db17c187" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/7e459e6b7006484fae72ea1625f8a171" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">怎么解决？我们首先找到一个全局唯一的key，将所有session关联起来。在这里，这个唯一key就是userId。我在WebSocketSession的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">HttpHeaders</code></span><span class="SemanticString">中存放了JWTToken，从中可以获取到userId，将它与每一个session都关联起来。回调无法全命中的问题则可以通过Redis广播来解决，所有机器都订阅同一个topic，由被命中的机器将消息广播出去，这样所有机器就都能接收到最新的回调信息，通过消息中的userId关联出所有活跃session，进而实现全局同步推送。过程中顺便对本机过期的无效session进行清理。</span></span></p></div><div id="https://www.notion.so/8c9c065ae7a549948881e25b0863c741" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1f1645b7c793454b8ac463019976e868" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如何保证消息总能够及时准确地推送到用户手中是一项有挑战性的事情</span></span></p></div><div id="https://www.notion.so/19378c558ef3493682dd80e7d67f2fb1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一般用户不会忠诚地一直等待着请求执行完，他们可能会把小程序切到后台，或者</span></span></p></div><div id="https://www.notion.so/54fbaa0c799141f795d2020461ff84cd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">重进小程序，同一端切换session，如何处理？回调时调到的不一定是他所在的机器，或者有可能他同时连接了多个终端</span></span></p></div><div id="https://www.notion.so/1a79754782a244908ecc2702e57d42dc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/2f0dc6e43e534972b941fd83dff4497c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/534f16645c67444eb3260919923dfe1a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上面说到用户是可能从移动端和PC端的小程序来回切换的，</span></span></p></div><div id="https://www.notion.so/b83d44156aa746c78752638581c19e8a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">要满足上述场景的需求其实也不难，由于session总是和userId绑定的，我们只要通过userId从内存中获取全量的session再推送即可，无论用户使用哪个客户端，只要给他活跃的session推消息，他总能及时收到最新的信息。问题是，我们有多个服务，而session是存放在本机内存中的，如果他另一个客户端的请求访问了别的机器怎么办？这时候就用到了Redis的广播功能，每次接收到最新进度消息时，就往所有服务广播，本机中存在对应session的，就推送消息，过程中可以顺便对本机过期的无效session进行清理。</span></span></p></div><div id="https://www.notion.so/c5bad625585a4fd391725fab3b48cb07" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/5f5961ba6a174236abf723defbb82885" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/5f5961ba6a174236abf723defbb82885"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">登录及身份校验</span></span></h2><div id="https://www.notion.so/acd5c9185af743dbbea7d6ad54239a2a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">背靠微信生态，小程序的身份校验可以很简单。无需额外的个人信息，利用小程序提供的原生登录方式</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html">小程序登录 / 小程序登录 (qq.com)</a></span><span class="SemanticString">就可以获取到用户的唯一key，也就是openId。在本小程序前期运营阶段，出于保护用户隐私的考虑，没有让任何用户填写过邮箱、手机号等个人信息，整个用户体系就是基于openId，但后来推出支付功能后，为了避免产生一些金钱上的纠纷，以及在用户产生意外损失时方便联系追回，还是将用户体系转到了手机号上。但openId还是需要保留，和手机号是多对多的关系。相较于openId，手机号肯定也是更加通用的，方便后续开发拓展到网页、APP等不同平台时同步用户信息。</span></span></p></div><div id="https://www.notion.so/64bf28666b404674afac39166cf0c7c7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">手机号的获取也很简单，也基于平台提供的原生登录方式</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html">用户信息 / 手机号 / 手机号快速验证 (qq.com)</a></span><span class="SemanticString">，且交互方式方便快捷（不过现在好像开始向开发者收费了，之前是免费的）。</span></span></p></div><div id="https://www.notion.so/0a1c9b7c418d4aa8b4ff9f671adc6c42" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">获取到openId后后端会将其加密并转为JWTToken返回给前端，同时返回的还有Token过期时间，还有用户身份。前端这些信息都存入storage，在token过期前3天向后端请求申请更新。用户身份包含游客、会员和白名单用户。会员和游客的区别就在于提供过手机号，游客在使用需要消耗积分的功能时会受限制，在提供手机号后即成为会员，此后不会被再次要求提供手机号。</span></span></p></div><div id="https://www.notion.so/3ecb4c65d84e4430833eed44b22375da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">后续请求的请求头都需要携带Token，实现身份校验。</span></span></p></div><div id="https://www.notion.so/7a374bf3afe048519e3180f3bfddda89" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/b219d6aa225a4072a893b2edc22cfead" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b219d6aa225a4072a893b2edc22cfead"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">支付</span></span></h2><div id="https://www.notion.so/08f8b56008894845812af79d342fe0c1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">小程序要想实现支付功能，接入官方的微信支付是正途，API文档见</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://pay.weixin.qq.com/docs/merchant/apis/mini-program-payment/mini-transfer-payment.html">小程序调起支付 - 小程序支付 | 微信支付商户文档中心 (qq.com)</a></span></span></p></div><div id="https://www.notion.so/6a898b35daf549ff905ab85cdae4e6ec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">官方提供了一些SDK，以java为例</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://pay.weixin.qq.com/docs/merchant/sdk-tools/quickstart-java.html">使用 Java SDK 快速开始 - SDK&amp;开发工具 | 微信支付商户文档中心 (qq.com)</a></span><span class="SemanticString">，需要预先获取证书和密钥，按照官方文档操作即可。</span></span></p></div><div id="https://www.notion.so/8808df2a6a5e4618b49646100e5895b3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/4401dd7dd55e448d88795380f79a01af" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">支付是通过异步回调的方式完成的，但由于对微信支付的回调状态机不是很清楚，官方文档对这块的描述也不够详尽，只有注意事项提示。</span></span></p></div><div id="https://www.notion.so/5daad019744b43e79b9e36f9ccf3a6f4" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F4f1aea9d-7c4c-4dd7-8683-6b86b6c5b468%2FUntitled.png?width=1606&amp;table=block&amp;id=5daad019-744b-43e7-9b9e-36f9ccf3a6f4"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2F4f1aea9d-7c4c-4dd7-8683-6b86b6c5b468%2FUntitled.png?width=1606&amp;table=block&amp;id=5daad019-744b-43e7-9b9e-36f9ccf3a6f4" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/11fa64af06614880b3e7dd5198982200" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为了防止订单状态错乱，做了以下保护措施：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/e3d6a5a176cc43cba7883360e6e2f5f7" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在回调方法中添加分布式锁（考虑到付费用户的体量，不存在性能问题）</span></span></li><li id="https://www.notion.so/43f66e831c8e40658ea127ea58c45556" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">不允许已进入结束态的订单被再次更新。</span></span></li><li id="https://www.notion.so/e0ea5c48d69f41c3aad0f0cbc8ce95fe" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">另外会使用定时任务定时扫描未关闭的订单，将其自动关闭。</span></span></li></ol><div id="https://www.notion.so/4009f199b0ae4e3dbf59f5d329b419b0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/498711ad14fd4427878e643e019b5b84" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/cb5a059913754762a1454e366b958047" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/af38396eb6a34a1eae29cd630be73a75" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/af38396eb6a34a1eae29cd630be73a75"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">版本发布</span></span></h1><div id="https://www.notion.so/7b02bd1b7fd64c469895dd01aa73eb90" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">小程序在运营过程中免不了要修复各种bug，以及不断推出新功能以追赶市场。所以版本迭代实际是非常快的，我个人来说基本是一周一次，甚至一周几次。这就导致了一个版本切换的问题，新版本上了，旧版本还有人在用，如何处理？</span></span></p></div><div id="https://www.notion.so/32ea430b25444021b0176e97e6f3dd80" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一个常用做法是做兼容，一个接口同时向下兼容多个版本。但这个方案实际实施起来操作成本很高，经常改一个接口要考虑多个兼容场景，在这么高的迭代频率下，对我个人而言不是很现实。更简单粗暴的方案是，同时保留后端服务的旧版本。前端小程序的多个版本和后端服务的多个版本一一对应，通过url路径来区分路由，这样用户无论访问什么版本的小程序，请求都能够被正确路由到目标服务端口。一般来说，同时保留三个版本是足够的，后面再有新版本时，就可以把最旧的那个服务给下掉了。值得一提的是，由于nginx修改配置无需重启，所以通过这种方式可以实现无卡顿切换，你临时切换一个版本来修复一下bug，用户都是无感知的。（中间因为更换了主体，所以会有新版和旧版小程序）</span></span></p></div><div id="https://www.notion.so/16bc9d82a6fb41d493ad2f8166005b76" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/368d9fc6fa434db384c0cfa9bd50402a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SpringBoot服务都是通过jar包的方式手动部署的，每个版本都有对应的启停脚本，区别仅在于路径和端口号。</span></span></p></div><pre id="https://www.notion.so/d6f2bf5b0a5043ac835ae194a4799480" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>#! /bin/bash
# springboot启动脚本

P_NAME=tna-service-2.4.9-param-RELEASE.jar
PATH_PREFIX=/root/autodl-tmp/ai/springboot
LOG_FILE_NAME=start_$(date +%Y-%m-%d).log
count=`jps |grep $P_NAME |grep -v &quot;grep&quot; |wc -l`
if [ $count -gt 0 ]; then
    echo $P_NAME &quot;正在运行中&quot;
else
    echo $P_NAME &quot;未运行，开始启动...&quot;
    nohup java -jar -Dserver.port=7003 \
          -Dloader.path=$PATH_PREFIX/lib \
          -Dspring.config.location=$PATH_PREFIX/resources/application.yaml \
          $PATH_PREFIX/$P_NAME  \
          &gt;&gt; $PATH_PREFIX/logs/start/$LOG_FILE_NAME 2&gt;&amp;1 &amp;
    count=`jps |grep $P_NAME |grep -v &quot;grep&quot; |wc -l`
    if [ $count -gt 0 ]; then
        echo $P_NAME &quot;启动成功！&quot;
    else
        echo $P_NAME &quot;启动失败！&quot;
    fi
fi
echo &quot;查看启动日志:\n&quot;
echo &quot;start:\n&quot;tail -n 200 $PATH_PREFIX/logs/start/$LOG_FILE_NAME&quot;\n&quot;
tail -n 200 $PATH_PREFIX/logs/start/$LOG_FILE_NAME
echo &quot;business:\n&quot;tail -n 200 $PATH_PREFIX/logs/tna_$(date +%Y-%m-%d)_0.log</span></span></span></code></pre><div id="https://www.notion.so/48bc412deebf475c9976c80fabde6448" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">还有守护脚本，用于防止服务意外停止的情况。</span></span></p></div><pre id="https://www.notion.so/7c3d72d6271d43369ce4d460582f978c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>#! /bin/bash
# author lyz
# time 2023-01-22 15:04:27
# springboot守护脚本

PATH_PREFIX=/root/autodl-tmp/ai/springboot
P_NAME=tna-service-2.4.9-param-RELEASE.jar
LOG_FILE_NAME=protect_log_$(date +%Y-%m-%d).log
count=`jps |grep $P_NAME |grep -v &quot;grep&quot; |wc -l`
if [ $count -gt 0 ]; then
echo `date &quot;+%Y-%m-%d %H:%M:%S&quot;` Checking &gt;&gt; $PATH_PREFIX/logs/protect/$LOG_FILE_NAME
else
# 若进程已经关闭，则拉起
echo `date &quot;+%Y-%m-%d %H:%M:%S&quot;` Starting &gt;&gt; $PATH_PREFIX/logs/protect/$LOG_FILE_NAME
sh $PATH_PREFIX/scripts_param/start.sh &gt;&gt; $PATH_PREFIX/logs/protect/$LOG_FILE_NAME
fi</span></span></span></code></pre><div id="https://www.notion.so/2756b2a620724be2b841f1081fbb4156" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3c5208b5ff5b4e73bd66a9aad881298e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一次新版本上线大概需要经历以下步骤：</span></span></p></div><div id="https://www.notion.so/704e99225bdc451fa983b302a0f7e4a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8edfe077a521417383828b3cbbc155e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">开发测试阶段：</span></span></p></div><div id="https://www.notion.so/62da176e3db94fb59b133a38aef63820" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">代码提交git</span></span></p></div><div id="https://www.notion.so/412dc35ca8a44a868c337f7338623218" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">meven打包生成jar</span></span></p></div><div id="https://www.notion.so/2e37b34c77724988a0ed0f4ad4ccede7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">修改脚本中的路径和端口号</span></span></p></div><div id="https://www.notion.so/15790ca03c3e45f3865399f3a9f83e66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">rsync命令同步脚本和jar包到云端</span></span></p></div><div id="https://www.notion.so/cbcd7b7d1a3c400cb1a0271b8d9e4c0a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">运行旧版本jar停止脚本，停止旧版服务，释放端口号</span></span></p></div><div id="https://www.notion.so/1510131a1373496ebf18d28a92d25cf3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">运行新版本jar启动脚本，启动新版服务</span></span></p></div><div id="https://www.notion.so/5e232ca338e048ba8502104a4917d37f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9d6aee9a2a804a01b8be292d25de2b6d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上线阶段：</span></span></p></div><div id="https://www.notion.so/92b83edc6e334afd8382215dab8191e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">修改nginx配置，将旧版URL与端口映射改为新版</span></span></p></div><div id="https://www.notion.so/f5696829e6c54a12b824787aa4a3240d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/99a090b8510d423585da1ce1f396e31b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/655a60f3f73a4e58a6679b7d117af89b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/318c8a86e4d840efa3587171b0706a29" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/318c8a86e4d840efa3587171b0706a29"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">踩过的坑</span></span></h1><div id="https://www.notion.so/b68b40ceac0a49cfa5debc71a7e815ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1a1ef46606b64efc9333c27c07a58690" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SD启动时添加了参数--medvram</span></span></p></div><div id="https://www.notion.so/13d0391b62314044bd09cee4a24c0dd1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当时为了节约显存添加了这个参数，但添加后进程对内存的占用高得离谱，而且无法回落，这个在生产环境绝对是不建议添加的，只有在本地硬件条件较差的机器上测试时，显存过小无法正常运行才需要添加。</span></span></p></div><div id="https://www.notion.so/a95c1bb388d84a26a7a21efbdab5b585" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/650c59cc14c64b44bb75115dde6079bf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SD高频率出现黑图</span></span></p></div><div id="https://www.notion.so/bb49f289dc794160aa0d8f2a83ec7672" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">出现黑图的原因是半精度浮点溢出，在启动参数后添加-no-half-vae，禁用vae的半精度模式可以解决，</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Command-Line-Arguments-and-Settings">官方wiki</a></span><span class="SemanticString">有对各启动参数的完整说明。</span></span></p></div><div id="https://www.notion.so/a4334a747f3e459b92242aa1abab7e42" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/49ca233ce0eb4ec4bd8b5c90a3b4dd49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">服务器时间不一致</span></span></p></div><div id="https://www.notion.so/fee24ec5b7024568a81a4dc3351c549a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在将服务迁移到AutoDL的GPU云服务器时，大量用户反馈登录异常。查看日志发现JWTToken大量报错，提示Token校验时间早于生成时间。经排查发现是两台服务器时间不一致（用户在时间较晚的机器上生成了Token，下一个请求又去时间较早的服务器校验）导致，当时急于修复bug，校正服务器时间有点繁琐，由于只影响了token的生成，在生成JWTToken时取巧，将签发时间统一提前了10min，覆盖了两台服务器的时间差值。但后续租用云服务器时，要首先注意不同服务器自己的时间问题。其实服务器之间的时间同步一直也是分布式问题中的一个难点，无法做到完全同步，但至少不应该出现相差几秒甚至几十秒的情况，这方面大的云服务器厂商会做得好一点。</span></span></p></div><div id="https://www.notion.so/f3731715da7d4f619d79ef9c03180d87" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f41f138e7677486cbec8696c200c40e3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">小程序被关小黑屋</span></span></p></div><div id="https://www.notion.so/dd08605080ec4dabb62659c60ee11824" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">小程序有比网页APP等其它客户端更为严格的审核机制，每次发布都需要人工审核，也会针对用户反馈进行审核。在运营初期时因为只关注于新增内容，忽略了审核的重要性，被用户举报，直接关了7天小黑屋，期间小程序0曝光，0新用户。后来想要给图片加AI审核，发现各大厂商的API都非常贵，好在微信官方也是提供了</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/sec-center/sec-check/msgSecCheck.html">内容安全识别API</a></span><span class="SemanticString">的，在接入之后，就没再出现过审核相关问题了。</span></span></p></div><div id="https://www.notion.so/7c3bc327672a436aa54101c0cfd223cd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/b20752ac46fe4becad24317552d9ad3c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/9f0097067ee946aab4c815d3ae745e96" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/9f0097067ee946aab4c815d3ae745e96"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">一些技巧</span></span></h1><div id="https://www.notion.so/719dc656c3774717bc89d80b1c358d4a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">个人小程序无法做支付！建议一开始就以公司或个体工商户为主体！我就是一开始以个人为主体，后来为了接入支付功能，被迫舍弃已有的好评星级和流量，新申请了一个小程序，还需要同时维护新旧版本。</span></span></p></div><div id="https://www.notion.so/b20c4105cf7444ed993f7b843adfa27b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/521928af54574671abbb4a1317033ec7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">支付需要营业执照，可以在淘宝上办，如果怕信息泄露，可以找熟人。营业执照的办法不同城市不同，有些会要求有户口或暂住证，像小程序这种纯线上的，可以以自己家乡的住址来办一个。淘宝会提供线上店铺地址，但小程序没有</span></span></p></div><div id="https://www.notion.so/cae4031068cf428288a40f5a63b680d3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/75ab9b92ee0341f285ad40dedd3034e2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在用营业执照认证主体时，记得认证微信公众号主体，不要认证小程序</span></span></p></div><div id="https://www.notion.so/4e8f718b0c9e4678aa2137e6fa58b56a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/05b377a224b94e4495382a5b6437f145" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">挑选GPU时，只需看半精度，影响生成速度的主要是半精度算力。</span></span></p></div><div id="https://www.notion.so/77e3c4a678644495ac96a90487bef0eb" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fec2aaa38-b81d-4a33-ab31-6436f97d25ac%2FUntitled.jpeg?width=1192&amp;table=block&amp;id=77e3c4a6-7864-4495-ac96-a90487bef0eb"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F48a56ef1-1ae6-4081-9f6e-3383f8b4ee16%2Fec2aaa38-b81d-4a33-ab31-6436f97d25ac%2FUntitled.jpeg?width=1192&amp;table=block&amp;id=77e3c4a6-7864-4495-ac96-a90487bef0eb" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">图片来自AutoDL算力市场</span></span></figcaption></figure></div><div id="https://www.notion.so/51c07a312616427c8d5b2c4b09b5381d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/dc0013f8c39243eb96c3907b6a0a99bd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SD优化参数</span></span></p></div><pre id="https://www.notion.so/e5c486ee672a462e9955acbfbdee9f60" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>点击Settings 选项卡
Stop At last layers of CLlP model改为2
Eta noise seed delta 设置为31337
eta (noise multiplier) for ancestral samplers 设置为 1
点击apply settings</span></span></span></code></pre><div id="https://www.notion.so/f22a75199a2d4c6e9bf43904380ac93d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/43c0d24517b0440b819d85322ff6fefc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/e404ff9c6ad5497f80ea4f369f4a53f2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/e404ff9c6ad5497f80ea4f369f4a53f2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">部署与迁移</span></span></h1><div id="https://www.notion.so/da2fd999da7848bc9d29d6d93e9bdaa3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/bd0176a8724d4792b3fca52023fa6d07" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/bd0176a8724d4792b3fca52023fa6d07"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">SD部署方式</span></span></h2><div id="https://www.notion.so/0737c910fb0e4aac84fce6d5c68fc1cb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://zhuanlan.zhihu.com/p/569663856">https://zhuanlan.zhihu.com/p/569663856</a></span></span></p></div><div id="https://www.notion.so/8008159eb0f24cc98c6dd5811c4fa672" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/f27c472d8c5a44cfb651a34fd028a75f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f27c472d8c5a44cfb651a34fd028a75f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">迁移</span></span></h2><div id="https://www.notion.so/e954dfe5adbb467294bc688e52b0ed52" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">服务部署完成后，自然是希望不再迁移，但服务器总有到期的一天，也总会有更廉价的服务器出现，所以迁移在开发过程中总是无可避免的。</span></span></p></div><div id="https://www.notion.so/0ad00be3aaa24e5bb2019bc4ecd79f88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/a9efb2812fc7455ca74ace9eebe39d46" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/a9efb2812fc7455ca74ace9eebe39d46"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">MySQL数据库迁移</span></span></h3><div id="https://www.notion.so/bd4e204e0b4b48fbb055ff651a582ec2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">数据库迁移最重要的是备份，最好日常就将SQL导出做定期多端备份。</span></span></p></div><pre id="https://www.notion.so/a0a9e5c0428a43f5a570656fc92d8047" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># 备份</span>

<span class="token comment"># 按库导出</span>
mysqldump <span class="token comment">--single-transaction --master-data=2 --quick -u root -p db_name > db_name.sql</span>
<span class="token comment"># 按表导出</span>
mysqldump <span class="token comment">--single-transaction --master-data=2 --quick -u root -p db_name table_name > table_name.sql</span>

<span class="token comment"># zip压缩</span>
gzip db_name<span class="token punctuation">.</span><span class="token keyword">sql</span>
<span class="token comment"># rsync 限速传输</span>
rsync <span class="token operator">-</span>avz <span class="token comment">--bwlimit=600KB db_name.sql.gz user@ip:/root/path</span>

<span class="token comment"># 恢复</span>
gunzip db_name<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>gz
mysql <span class="token operator">-</span>u root <span class="token operator">-</span>p db_name <span class="token operator">&lt;</span> <span class="token keyword">databases</span><span class="token punctuation">.</span><span class="token keyword">sql</span></span></span></span></code></pre><div id="https://www.notion.so/5c0722f1989a49a5916e29bad6224ffe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/c538eb1bdd1b481d9766b1c9e86c7a29" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c538eb1bdd1b481d9766b1c9e86c7a29"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">SD服务迁移</span></span></h2><div id="https://www.notion.so/16e34c0e188a4ee28d02722940a67c51" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">迁移时，先按照pytorch，注意新服务器CUDA版本，要根据实际的CUDA版本安装对应的pytorch，可通过官网</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://pytorch.org/get-started/previous-versions/">查看不同CUDA版本对应的pytorch版本命令 </a></span></span></p></div><pre id="https://www.notion.so/e52034b1ae4f429aa16f804acf247ebd" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span># ** 查看cuda版本
# 查看当前Cuda的版本，即实际安装的Cuda版本
nvcc --version
（
需要安装nvidia-cuda-toolkit
或
export PATH=&quot;/usr/local/cuda-11.4/bin:$PATH&quot;
export LD_LIBRARY_PATH=&quot;/usr/local/cuda-11.4/lib64:$LD_LIBRARY_PATH&quot;
）
# 查看支持的最高版本的cuda
nvidia-smi

# 查看当前服务器预装pytorch版本
python -c &quot;import torch;print(torch.__version__);print(torch.cuda.is_available());print(torch.version.cuda)&quot;


# pytorch官网查看不同CUDA版本对应的pytorch版本命令 
# CUDA 11.3
pip --default-timeout=600000 install torch==1.11.0+cu113 torchvision==0.12.0+cu113 torchaudio==0.11.0 --extra-index-url https://download.pytorch.org/whl/cu113

# 查看安装后的pytorch版本
python -c &quot;import torch;print(torch.__version__);print(torch.cuda.is_available());print(torch.version.cuda)&quot;</span></span></span></code></pre><div id="https://www.notion.so/551d54627f0d450998d5a3ee7647201a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1dccd40a94984207a1ee0414d93c2506" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">再安装SD，关键在于确保新旧服务commit一致。平时没事不要pull，不求最新，但求稳定。</span></span></p></div><pre id="https://www.notion.so/981368d77691485fbe8254ec7758bf6b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span># 在旧机器执行
# 查看当前commit
git rev-parse HEAD

# 在新机器执行
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui
# 切换到相同commit
git checkout 30b1bcc64e67ad50c5d3af3a6fe1bd1e9553f34e</span></span></span></code></pre><div id="https://www.notion.so/45e5d31d492443b8bbf370ba87680fd2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/344379a3a3524b08a73f4e234500d7a3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/344379a3a3524b08a73f4e234500d7a3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">结语</span></span></h1><div id="https://www.notion.so/c78f525259104ed4b6948e31d3350727" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从敲下第一行代码到停止运营，从2022年10月至2023年8月，次元吟小程序一共存活了10个月（未满一年略感遗憾），其中耗费了无数个周末，上下班的路上也都在敲代码（不夸张地说，有20%的内容都是在地铁上完成的）。用户半夜报bug，马上起来修复也是常事。其实还有一些用户提的需求都还未完成，例如相册、提示词功能等，虽有遗憾，但整体是满足的。</span></span></p></div><div id="https://www.notion.so/3af21cbe35314aba9cec719c6db94c53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/fc0aba67eb8b4c04a443d22e99960b59" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这个小程序是我第一个独立开发的应用，之前几乎没接触过前端代码，没有接触过小程序，更没有接触过AI绘画，可以说每一步都是第一次。以及被营业执照、变更主体、各种认证折腾得焦头烂额。不过整体是快乐的，很长一段时间里，我都处于一种创造的迷醉感当中。</span></span></p></div><div id="https://www.notion.so/d84d7610bdf545918006ee35bbd01ced" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/2d8b08eb0b7149a8a0347d54efc4ca10" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">写这篇博客的时候，为了尽量还原细节，我把代码又从头到尾看了一遍，甚至把关掉的服务器又重新打开。过去的日日夜夜像幻灯片一样又重新展示出来，令人感慨恍惚。隔了两个月才开始记录，也是因为害怕回忆面对。最终决定这么事无巨细地列出来，不只是为了给同样对AI感兴趣、有意做小程序独立开发的小伙伴们一点借鉴，也是为了给自己留下一个尽量完整的回忆。</span></span></p></div><div id="https://www.notion.so/5113060a460a477c925a5cffe6cfcac3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/2dbacc39976145248bc797bac4257495" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/2dbacc39976145248bc797bac4257495"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">注</span></span></h1><div id="https://www.notion.so/31382bf634634ce6bcc5ede4844cf78f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">[1]</mark></span><span class="SemanticString">MidJourney，简称MJ，是AI绘画应用中公认做得最好的（现在不一定），大概在2023年5月的时候大放光彩。由于国内无法访问，且交互界面寄生于discord，对于国内用户来说，使用有一定门槛。国内各个AI应用就打起了MJ API的主意，纷纷将MJ接入到自己的应用中，借此又收割了一波会员费。</span></span></p></div><div id="https://www.notion.so/d3a9e7cff00747ddb991bf9e556a7b2e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/2ba134f0c1e4493b8c59fc2cf427f0dc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">[2]</mark></span><span class="SemanticString">不知道目前是否支持，当时只有一个提供切换操作的api，但响应速度很慢，无法满足在不同用户请求之间无感切换的需求。当时看了官方wiki和各种issue也没找到解决方案。</span></span></p></div><div id="https://www.notion.so/b512fbffd7084b7f9260a6d6610ae1f5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; ZaneBlog 2023</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>